
; Rule to generate link flags, especially for static linking
(rule
 (with-stdout-to link_flags.dune
  (run ./gen-link-flags.sh %{env:LINK_MODE=dynamic} %{ocaml-config:system})))

; Executable main rule
(executable
  (name           main)
  (public_name    dolmen)
  (package        dolmen_bin)
  (link_flags     (:standard (:include link_flags.dune)))
  (libraries
    ; external deps
    cmdliner fmt gen
    ; dolmen deps
    dolmen dolmen.intf dolmen.std
    dolmen_type dolmen_loop dolmen_model
    ; Memtrace dependency
    (select memory_profiler.ml from
            (memtrace -> memory_profiler.memtrace.ml)
            (         -> memory_profiler.missing.ml))
    )
)

; Rule to generate a man page for dolmen
(rule
  (target        dolmen.1)
  (action (with-outputs-to %{target} (run dolmen --help=groff)))
)

; Install the man page
(install
 (section  man)
 (files    dolmen.1)
 (package  dolmen_bin)
)
